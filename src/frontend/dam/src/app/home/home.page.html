<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Dashboard de Proyectos</ion-title>
    <ion-buttons slot="end">
      <!-- Botón de logout mejorado -->
      <ion-button 
        fill="outline" 
        size="small"
        (click)="logout()"
        color="danger"
        class="logout-btn">
        <ion-icon name="log-out-outline" slot="start"></ion-icon>
        Cerrar Sesión
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  
  <!-- Pull to refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="refreshProjects($event)">
    <ion-refresher-content
      pullingIcon="chevron-down-circle-outline"
      pullingText="Desliza para actualizar"
      refreshingSpinner="circles"
      refreshingText="Actualizando proyectos...">
    </ion-refresher-content>
  </ion-refresher>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Cargando dashboard...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading" class="dashboard-container">
    
    <!-- Header Stats -->
    <div class="stats-header">
      <div class="welcome-message">
        <h1>¡Bienvenido de vuelta!</h1>
        <p>Gestiona tus proyectos de sensores MPU</p>
      </div>
      <div class="stats-cards">
        <div class="stat-card">
          <div class="stat-number">{{ getActiveProjectsCount() }}</div>
          <div class="stat-label">Proyectos Activos</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ projects.length }}/2</div>
          <div class="stat-label">Total de Proyectos</div>
        </div>
      </div>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
      <ion-button 
        expand="block"
        [disabled]="projects.length >= 2"
        (click)="openCreateProjectModal()"
        class="create-project-btn">
        <ion-icon name="add" slot="start"></ion-icon>
        Crear Nuevo Proyecto
      </ion-button>
      
      <ion-chip *ngIf="projects.length >= 2" color="warning" class="limit-warning">
        <ion-icon name="warning-outline"></ion-icon>
        <ion-label>Límite alcanzado (2/2)</ion-label>
      </ion-chip>
    </div>

    <!-- Empty State -->
    <div *ngIf="projects.length === 0" class="empty-state">
      <div class="empty-icon">
        <ion-icon name="analytics-outline"></ion-icon>
      </div>
      <h2>¡Comienza tu primer proyecto!</h2>
      <p>No tienes proyectos creados aún. Crea tu primer proyecto con sensor MPU para comenzar a monitorear datos en tiempo real.</p>
      <ion-button 
        expand="block"
        fill="outline"
        (click)="openCreateProjectModal()"
        class="empty-action-btn">
        <ion-icon name="add" slot="start"></ion-icon>
        Crear Primer Proyecto
      </ion-button>
    </div>

    <!-- Projects Grid -->
    <div *ngIf="projects.length > 0" class="projects-grid">
      <ion-card *ngFor="let project of projects" class="project-card" [class.disabled-project]="!project.activo">
        
        <!-- Card Header -->
        <ion-card-header>
          <div class="card-header-content">
            <div class="project-info">
              <ion-card-title>{{ project.nombre }}</ion-card-title>
              <div class="project-badges">
                <ion-chip color="primary" outline="true">
                  <ion-icon name="hardware-chip-outline"></ion-icon>
                  <ion-label>{{ project.sensor }}</ion-label>
                </ion-chip>
                <ion-chip 
                  [color]="project.activo ? 'success' : 'medium'" 
                  outline="true">
                  <ion-icon 
                    [name]="project.activo ? 'checkmark-circle-outline' : 'pause-circle-outline'">
                  </ion-icon>
                  <ion-label>{{ project.activo ? 'Activo' : 'Deshabilitado' }}</ion-label>
                </ion-chip>
              </div>
            </div>
          </div>
        </ion-card-header>

        <!-- Card Content -->
        <ion-card-content>
          <div class="project-details">
            <div class="detail-row">
              <span class="detail-label">Tópico MQTT:</span>
              <span class="detail-value topic-value">{{ project.topico }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Fecha de Creación:</span>
              <span class="detail-value">{{ project.fechaCreacion | date:'dd/MM/yyyy' }}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Última Lectura:</span>
              <span class="detail-value" [class.no-data]="project.ultimaLectura === 'Sin lecturas'">
                {{ project.ultimaLectura }}
              </span>
            </div>
          </div>

          <!-- Project Actions -->
          <div class="project-actions">
            
            <!-- Primary Actions -->
            <div class="primary-actions">
              <ion-button 
                expand="block"
                fill="solid"
                [disabled]="!project.activo"
                (click)="viewProject(project)"
                color="primary"
                class="view-data-btn">
                <ion-icon name="analytics" slot="start"></ion-icon>
                Ver Datos
              </ion-button>
            </div>

            <!-- Secondary Actions -->
            <div class="secondary-actions">
              
              <!-- Edit Button -->
              <ion-button 
                fill="outline"
                size="default"
                (click)="openEditProjectModal(project)"
                color="medium"
                class="action-btn">
                <ion-icon name="create-outline" slot="start"></ion-icon>
                Editar
              </ion-button>

              <!-- Enable/Disable Button -->
              <ion-button 
                fill="outline"
                size="default"
                (click)="toggleProjectStatus(project)"
                [color]="project.activo ? 'warning' : 'success'"
                class="action-btn">
                <ion-icon 
                  [name]="project.activo ? 'pause-outline' : 'play-outline'" 
                  slot="start">
                </ion-icon>
                {{ project.activo ? 'Deshabilitar' : 'Habilitar' }}
              </ion-button>

              <!-- Delete Button -->
              <ion-button 
                fill="outline"
                size="default"
                (click)="confirmDeleteProject(project)"
                color="danger"
                class="action-btn">
                <ion-icon name="trash-outline" slot="start"></ion-icon>
                Eliminar
              </ion-button>
              
            </div>
          </div>
        </ion-card-content>
      </ion-card>
    </div>
  </div>

  <!-- Create Project Modal -->
  <ion-modal [isOpen]="showCreateModal" (didDismiss)="closeCreateProjectModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>Crear Nuevo Proyecto</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeCreateProjectModal()" fill="clear" color="light">
              <ion-icon name="close" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content class="ion-padding">
        <form [formGroup]="createProjectForm" (ngSubmit)="createProject()">
          
          <!-- Project Name -->
          <ion-item class="form-item">
            <ion-label position="stacked">Nombre del Proyecto *</ion-label>
            <ion-input 
              formControlName="nombre"
              placeholder="Ej: Monitoreo Vibración Máquina"
              (ionInput)="onProjectNameChange()">
            </ion-input>
          </ion-item>
          <ion-note 
            *ngIf="createProjectForm.get('nombre')?.invalid && createProjectForm.get('nombre')?.touched"
            color="danger">
            El nombre del proyecto es requerido (mínimo 3 caracteres)
          </ion-note>

          <!-- Sensor Selection -->
          <ion-item class="form-item">
            <ion-label position="stacked">Tipo de Sensor *</ion-label>
            <ion-select 
              formControlName="sensor"
              (ionChange)="onSensorChange()"
              placeholder="Selecciona el tipo de sensor">
              <ion-select-option value="MPU">
                MPU (Unidad de Procesamiento de Movimiento)
              </ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Generated Topic Preview -->
          <ion-item class="form-item">
            <ion-label position="stacked">Tópico MQTT (Generado Automáticamente)</ion-label>
            <ion-input 
              [value]="getGeneratedTopic()"
              readonly="true"
              class="topic-preview">
            </ion-input>
            <ion-note slot="helper">
              Se genera automáticamente basado en el nombre del proyecto y sensor
            </ion-note>
          </ion-item>

          <!-- MQTT URL -->
          <ion-item class="form-item">
            <ion-label position="stacked">URL del Broker MQTT *</ion-label>
            <ion-input 
              formControlName="mqttUrl"
              placeholder="mqtt://broker.ejemplo.com:1883">
            </ion-input>
          </ion-item>
          <ion-note 
            *ngIf="createProjectForm.get('mqttUrl')?.invalid && createProjectForm.get('mqttUrl')?.touched"
            color="danger">
            URL del broker MQTT es requerida
          </ion-note>

          <!-- Sensor Information -->
          <ion-card *ngIf="createProjectForm.get('sensor')?.value" class="info-card">
            <ion-card-header>
              <ion-card-title color="primary">
                <ion-icon name="information-circle" slot="start"></ion-icon>
                Información del Sensor {{ createProjectForm.get('sensor')?.value }}
              </ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <p><strong>Descripción:</strong> Sensor de movimiento con acelerómetro y giroscopio</p>
              <p><strong>Parámetros:</strong> Ejes X, Y, Z (g)</p>
              <p><strong>Aplicaciones:</strong> Detección de vibración, inclinación y movimiento</p>
            </ion-card-content>
          </ion-card>

          <!-- Preview Card -->
          <ion-card *ngIf="createProjectForm.get('nombre')?.value" class="preview-card">
            <ion-card-header>
              <ion-card-title color="success">
                <ion-icon name="eye" slot="start"></ion-icon>
                Vista Previa del Proyecto
              </ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <div class="preview-details">
                <p><strong>Nombre:</strong> {{ createProjectForm.get('nombre')?.value }}</p>
                <p><strong>Sensor:</strong> {{ createProjectForm.get('sensor')?.value || 'No seleccionado' }}</p>
                <p><strong>Tópico:</strong> <code>{{ getGeneratedTopic() }}</code></p>
                <p><strong>URL MQTT:</strong> {{ getFullMqttUrl() }}</p>
              </div>
            </ion-card-content>
          </ion-card>

          <!-- Warning -->
          <ion-card *ngIf="projects.length >= 2" color="warning">
            <ion-card-content>
              <div class="warning-content">
                <ion-icon name="warning" size="large"></ion-icon>
                <div>
                  <h4>Límite Alcanzado</h4>
                  <p>Has alcanzado el límite máximo de 2 proyectos por usuario.</p>
                </div>
              </div>
            </ion-card-content>
          </ion-card>

          <!-- Actions -->
          <div class="form-actions">
            <ion-button 
              expand="block"
              fill="outline"
              (click)="closeCreateProjectModal()"
              color="medium">
              <ion-icon name="close" slot="start"></ion-icon>
              Cancelar
            </ion-button>
            <ion-button 
              expand="block"
              type="submit"
              [disabled]="createProjectForm.invalid || projects.length >= 2 || isCreatingProject"
              color="primary">
              <ion-spinner *ngIf="isCreatingProject" name="crescent" slot="start"></ion-spinner>
              <ion-icon *ngIf="!isCreatingProject" name="add" slot="start"></ion-icon>
              {{ isCreatingProject ? 'Creando...' : 'Crear Proyecto' }}
            </ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Edit Project Modal -->
  <ion-modal [isOpen]="showEditModal" (didDismiss)="closeEditProjectModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>Editar Proyecto</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeEditProjectModal()" fill="clear" color="light">
              <ion-icon name="close" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      
      <ion-content>
        <form [formGroup]="editProjectForm" (ngSubmit)="updateProject()" class="edit-form">
          <div class="form-content">
            
            <!-- Project Name -->
            <ion-item class="form-item">
              <ion-label position="stacked">Nombre del Proyecto *</ion-label>
              <ion-input 
                formControlName="nombre"
                placeholder="Nombre del proyecto"
                [class.ion-invalid]="editProjectForm.get('nombre')?.invalid && editProjectForm.get('nombre')?.touched"
                [class.ion-valid]="editProjectForm.get('nombre')?.valid && editProjectForm.get('nombre')?.touched">
              </ion-input>
              <ion-note 
                slot="error" 
                *ngIf="editProjectForm.get('nombre')?.invalid && editProjectForm.get('nombre')?.touched">
                El nombre del proyecto es requerido
              </ion-note>
            </ion-item>

            <!-- Sensor Type (readonly) -->
            <ion-item class="form-item">
              <ion-label position="stacked">Tipo de Sensor</ion-label>
              <ion-input 
                formControlName="sensor"
                readonly="true"
                class="readonly-input">
              </ion-input>
              <ion-note>El tipo de sensor no puede modificarse una vez creado el proyecto</ion-note>
            </ion-item>

            <!-- Project Status -->
            <ion-item class="form-item">
              <ion-label>Estado del Proyecto</ion-label>
              <ion-toggle 
                formControlName="activo"
                slot="end"
                [checked]="editProjectForm.get('activo')?.value">
              </ion-toggle>
            </ion-item>

          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <ion-button 
              expand="block"
              fill="clear"
              (click)="closeEditProjectModal()"
              class="cancel-btn">
              Cancelar
            </ion-button>
            <ion-button 
              expand="block"
              type="submit"
              [disabled]="editProjectForm.invalid || isUpdatingProject"
              class="update-btn">
              <ion-spinner *ngIf="isUpdatingProject" name="crescent"></ion-spinner>
              <span *ngIf="!isUpdatingProject">Actualizar Proyecto</span>
            </ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>